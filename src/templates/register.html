<!DOCTYPE html>
<html>
<head>
    <title>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        #debug-info {
            font-size: 12px;
            color: #666;
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            display: none;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
        }
        .error-feedback {
            color: #dc3545;
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-4">
                <h2 class="mb-4">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
                <div id="message"></div>

                <form id="registerForm" onsubmit="event.preventDefault(); register();">
                    <div class="mb-3">
                        <label>–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
                        <input type="text" class="form-control" id="username" placeholder="min 3 —Å–∏–º–≤–æ–ª–∞" required>
                        <div class="error-feedback" id="usernameError"></div>
                    </div>

                    <div class="mb-3">
                        <label>Email</label>
                        <input type="email" class="form-control" id="email" placeholder="email@example.com" required>
                        <div class="error-feedback" id="emailError"></div>
                    </div>

                    <div class="mb-3">
                        <label>–ü–∞—Ä–æ–ª—å</label>
                        <input type="password" class="form-control" id="password" placeholder="min 6 —Å–∏–º–≤–æ–ª–æ–≤" required>
                        <div class="error-feedback" id="passwordError"></div>
                    </div>

                    <button type="submit" class="btn btn-primary w-100 mb-3" id="registerBtn">
                        –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
                    </button>
                </form>

                <p class="text-center">
                    <a href="/login">–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? –í–æ–π—Ç–∏</a>
                </p>

                <button type="button" class="btn btn-sm btn-secondary w-100 mt-2" onclick="toggleDebug()">
                    –ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–ª–∞–¥–∫—É
                </button>
                <div id="debug-info"></div>
            </div>
        </div>
    </div>

    <script>
        let debugVisible = false;

        function toggleDebug() {
            debugVisible = !debugVisible;
            document.getElementById('debug-info').style.display = debugVisible ? 'block' : 'none';
        }

        function addDebug(text) {
            const debugDiv = document.getElementById('debug-info');
            const time = new Date().toLocaleTimeString();
            debugDiv.innerHTML += `<div>[${time}] ${text}</div>`;
            console.log('üîç DEBUG:', text);
        }

        function clearDebug() {
            document.getElementById('debug-info').innerHTML = '';
        }

        function showError(elementId, message) {
            document.getElementById(elementId).textContent = message;
            document.getElementById(elementId).style.display = 'block';
        }

        function hideErrors() {
            document.querySelectorAll('.error-feedback').forEach(el => {
                el.style.display = 'none';
                el.textContent = '';
            });
        }

        async function register() {
            clearDebug();
            hideErrors();
            addDebug('üöÄ –ù–∞—á–∏–Ω–∞–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é...');

            const username = document.getElementById('username').value.trim();
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value.trim();

            addDebug(`üìù Username: "${username}"`);
            addDebug(`üìù Email: "${email}"`);
            addDebug(`üìù Password: ${password ? '******' : '–ø—É—Å—Ç–æ'}`);

            let hasError = false;

            if (!username) {
                showError('usernameError', '–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ');
                hasError = true;
            } else if (username.length < 3) {
                showError('usernameError', '–ú–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞');
                hasError = true;
            }

            if (!email) {
                showError('emailError', 'Email –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω');
                hasError = true;
            } else if (!email.includes('@')) {
                showError('emailError', '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email');
                hasError = true;
            }

            if (!password) {
                showError('passwordError', '–ü–∞—Ä–æ–ª—å –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω');
                hasError = true;
            } else if (password.length < 6) {
                showError('passwordError', '–ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤');
                hasError = true;
            }

            if (hasError) {
                addDebug('‚ùå –û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ');
                return;
            }

            const requestData = {
                username: username,
                email: email,
                password: password
            };

            addDebug('üì¶ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ: ' + JSON.stringify(requestData, null, 2));

            const btn = document.getElementById('registerBtn');
            btn.disabled = true;
            btn.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';

            try {
                addDebug('üì° –û—Ç–ø—Ä–∞–≤–∫–∞ POST –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ /api/register');

                const response = await fetch('/api/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                addDebug(`üì• –°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞: ${response.status} ${response.statusText}`);

                const responseData = await response.json();
                addDebug('üì• –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: ' + JSON.stringify(responseData, null, 2));

                if (response.ok) {
                    addDebug('‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω...');
                    localStorage.setItem('token', responseData.token);
                    showMessage('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ...');

                    // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –≥–ª–∞–≤–Ω—É—é
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 1500);
                } else {
                    addDebug(`‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${responseData.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
                    showMessage(responseData.error || '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏', true);
                }
            } catch (error) {
                addDebug(`‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ${error.message}`);
                showMessage('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å (F12).', true);
                console.error('Registration error:', error);
            } finally {
                btn.disabled = false;
                btn.textContent = '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è';
            }
        }

        function showMessage(text, isError = false) {
            const msgDiv = document.getElementById('message');
            msgDiv.innerHTML = `<div class="alert ${isError ? 'alert-danger' : 'alert-success'} alert-dismissible fade show" role="alert">${text}</div>`;

            setTimeout(() => {
                const alert = msgDiv.querySelector('.alert');
                if (alert) alert.remove();
            }, 5000);
        }

        document.getElementById('email').addEventListener('input', function() {
            const email = this.value.trim();
            const errorDiv = document.getElementById('emailError');
            if (email && !email.includes('@')) {
                errorDiv.textContent = '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email';
                errorDiv.style.display = 'block';
            } else {
                errorDiv.style.display = 'none';
            }
        });

        document.getElementById('username').addEventListener('input', function() {
            const username = this.value.trim();
            const errorDiv = document.getElementById('usernameError');
            if (username && username.length < 3) {
                errorDiv.textContent = '–ú–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞';
                errorDiv.style.display = 'block';
            } else {
                errorDiv.style.display = 'none';
            }
        });

        document.getElementById('password').addEventListener('input', function() {
            const password = this.value.trim();
            const errorDiv = document.getElementById('passwordError');
            if (password && password.length < 6) {
                errorDiv.textContent = '–ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤';
                errorDiv.style.display = 'block';
            } else {
                errorDiv.style.display = 'none';
            }
        });

        if (localStorage.getItem('token')) {
            window.location.href = '/';
        }
    </script>
</body>
</html>